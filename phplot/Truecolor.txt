phplot/Truecolor - Documentation for the experimental truecolor support
Last updated for PHPlot-5.1.1 (+CVS updates) on 2010-05-31
The project home page is http://sourceforge.net/projects/phplot/
-----------------------------------------------------------------------------
Overview:

This file documents the use of truecolor images in PHPlot. This includes
images with more colors, transparency control (alpha channel), and alpha
blending of colors.  Truecolor image support was added to PHPlot in
version 5.1.1 as an experimental feature.

    NOTICE:

    Truecolor support is experimental. This means the features and
    interface are subject to change in future releases, and these
    changes may be incompatible with the current implementation.
    Be aware of this before using truecolor in your application.

Feedback on this feature is welcome. Please use the "help" forum at
http://sourceforge.net/projects/phplot/

Contents:
  Application Interface - How to make truecolor PHPlot images
  Color Specification Extensions - How to specify colors with alpha
  Additional Operations on Truecolor Images - Advanced GD operations
  File Formats - Image file formats versus truecolor
  Plot Types - PHPlot plot types and truecolor with alpha blending
  Background Image - Caution about using a background image
  Implementation - How truecolor is implemented in PHPlot
  Palette Images - Truecolor features that also work with palette images
  History of this document

-----------------------------------------------------------------------------
Application Interface:

To use truecolor images, create an object of the derived class
PHPlot_truecolor instead of the class PHPlot. For example, replace:
          $plot = new PHPlot(800, 600);
with:
          $plot = new PHPlot_truecolor(800, 600);

That is all you need to do in order to create truecolor images. All PHPlot
methods are compatible with PHPlot_truecolor objects. An image file
produced from a PHPlot_truecolor object with no other programming changes
will be the same as an image file produced from a PHPlot object except as
described under File Formats below.

To use partially transparent colors (that is, colors with an alpha channel) 
with a PHPlot_truecolor object, you can specify an alpha value as part of a
color specification, and you can specify a default alpha value for all data
colors. Use of alpha values with a color specification is described below
under "Color Specification Extensions". Here are some examples of using
colors with an alpha specification:
    $plot->SetTextColor(array(192, 192, 33, 50));
This sets the color used for labels to red=192, green=192, blue=33, and
alpha=50. (This alpha translates to 50/127 transparency.)
    $plot->SetTickColor('blue:64');
This sets the color used for tick marks to the color 'blue' from the color
map, with alpha value 64  (64/127 transparency).

To specify a default alpha value for all data colors, provide the alpha
value as the new 3rd argument to SetDataColors:
    $plot->SetDataColors($my_color_array, NULL, 50);
This uses the colors specified in $my_color_array with a default alpha of
50. The default is applied to any color definition which does not already
have an alpha value.

This can also be used to apply an alpha value to the default data colors.
    $plot->SetDataColors(NULL, NULL, 50);
This retains the default data colors, but applies alpha = 50 (50/127
transparency) to all the colors. This is a quick way to get partially
transparent data colors without re-specifying all the colors.

-----------------------------------------------------------------------------
Color Specification Extensions:

Refer to the PHPlot Reference Manual for all of the functions that allow
you to control colors. The standard color specifications for PHPlot are:
    A color name from the color map, such as 'red'.
    A string of the form '#rrggbb' where each of rr, gg, and bb represent
the value of a color component (red, green, blue) as a 2 digit hexadecimal
number 00 to ff.
    A PHP array of 3 integers representing red, green, and blue in order
with each value between 0 and 255.

How you can specify colors in PHPlot is now extended to allow you to
provide an alpha channel value, which indicates the transparency of the
color.  Note that this works with both the base class (PHPlot) and the
extended class (PHPlot_truecolor).

These forms are recognized in addition to those listed above.
    A color name from the color map followed by a colon and alpha value as
a decimal number, such as 'red:60'. Alpha is between 0 and 127.
    A string of the form '#rrggbbaa' where each of rr, gg, and bb represent
the value of a color component (red, green, blue) as a 2 digit hexadecimal
number 00 to ff, and aa is the alpha value as a 2 digit hexadecimal number
00 to 7f.
    A PHP array of 4 integers representing red, green, and blue, an alpha
in order, with red, green, and blue between 0 and 255 and alpha between 0
and 127.

NOTE: This follows the GD convention of alpha value being a value between 0
and 127, with 0 meaning opaque and 127 meaning completely transparent. Be
aware that this convention differs from other systems, which often use
alpha of 0 to indicate complete transparency.

Color names can include an alpha value in the color map, or an alpha value
can be appended to a color in the color map. For example, you can define a
color map with these colors:
     'red2' => array(255, 0, 0, 80),  // Red with 80/127 transparency
     'red' => array(255, 0, 0),       // Red
Then you can use 'red2' or 'red:80' to get the same result.

An alpha value appended to a color name overrides an alpha value in the
color map, so using the above example 'red2:100' would be red with
alpha=100.

-----------------------------------------------------------------------------
Additional Operations on Truecolor Images Using Callbacks:

Advanced operations on truecolor PHPlot images are possible using PHPlot
callbacks. Refer to the PHPlot Reference Manual for additional information
about using callbacks, and to the GD section of the PHP Manual for
information about these operations. Here are some of the operations you can
perform, and their corresponding GD functions:

+ imageantialias()
You can turn on anti-aliasing of truecolor images. This must be done before
anything is drawn, so the pre-drawing callback 'draw_setup' is used. Here is
a partial example:
    function pre_plot($img)
    {
        imageantialias($img, True);
    }

    ...
    $plot = new PHPlot_truecolor(1024, 768);
    $plot->SetCallback('draw_setup', 'pre_plot');

Note: There are limitations with anti-aliased images. You cannot use wide
lines (SetLineWidths). Patterned lines do not work, so if you are displaying
X or Y grid lines you must use SetDrawDashedGrid(False) to make these solid.

+ imagealphablending() and imagelayereffect()
These functions control the combining of partially transparent colors. They
can be used via a 'draw_setup' callback, in the same way as imageantialias
in the example above. Note that alpha blending is on by default.

+ imagegammacorrect()
You can have the GD library perform gamma adjustment on a truecolor image.
This must be done after all drawing, so the post-drawing callback 'draw_all'
is used. Here is a partial example:
    function post_plot($img)
    {
        imagegammacorrect($img, 1.0, 0.5); // Input gamma=1, output gamma=.5
    }

    ...
    $plot = new PHPlot_truecolor(1024, 768);
    $plot->SetCallback('draw_all', 'post_plot');

-----------------------------------------------------------------------------
File Formats:

PHPlot can produce JPEG, PNG, and GIF image files (and possibly others).
You select the PHPlot output image file format with SetFileFormat().

PHPlot works with GD images before producing an image file. There are two
types of GD images: truecolor and palette. Truecolor images represent
pixels as 32 bit values, combining 8 bits each of red, green, and blue
components with a 7 bit alpha (transparency) value. Palette images use a
color table with at most 256 entries, and represent pixels as 8 bit indexes
into the color table. The palette image color table entries have 32 bit
values, with the same components as truecolor image pixel values. So
palette images in GD can have at most 256 unique colors, but there is no
limitation on the number of unique colors in truecolor images.

As long as you don't specify a background image when creating your plot
object, truecolor images are created with the PHPlot_truecolor class, and
palette images are created with the PHPlot class. If you specify a
background image, the GD image created by PHPlot matches the type -
truecolor or palette - of your background image file. More on background
image files can be found below.

What happens when you output the GD image to an image file depends on the
image file format you select.

JPEG image files are always truecolor. Whether you have a GD palette image
or truecolor image, you will get a truecolor image file.  Note: You are
discouraged from using JPEG images with PHPlot, because they are not
optimal for this type of graphical information due to use of lossy
compression.

GIF image files are always palette type, limited to 256 colors. If
you have a GD palette image, you will get a palette GIF image file with the
colors you used in your plot. If you have a a GD truecolor image, GD will
convert your image to palette format, reducing the number of colors to 256
if necessary. This may change the appearance of your plot. Note that some
versions of the PHP manual for imagecreatetruecolor() incorrectly state
that you cannot output a GIF file from a truecolor GD image.

PNG image files support truecolor images and palette images of various
color depths.  If you have a GD palette image, you will get a palette PNG
image file. If you have a GD truecolor image, you will get a truecolor PNG
image file. Note that by default, even though PNG truecolor image files
support an alpha channel, GD eliminates the alpha channel when producing a
PNG file. The visual effects of alpha blending are reproduced using opaque
colors. GD apparently does this due to poor support in viewers for alpha
channels. Refer to the PHP Manual page on imagesavealpha() for details.

In the initial release of truecolor support in PHPlot-5.1.1, alpha channel
information was ignored when using a PHPlot object, and only used with a
PHPlot_truecolor object. This was changed after PHPlot-5.1.1, and alpha
channel information is used for both PHPlot and PHPlot_truecolor classes.
However, alpha channel information is not always useful with palette
images. More on this can be found below.

-----------------------------------------------------------------------------
Plot Types:

All PHPlot plot types work with truecolor images, but not all plot types
work well with alpha blending of data colors. (Alpha blending refers to
specifying colors which are partially transparent, and having GD merge
overlaid colors.)

Pie charts - Avoid using alpha blending with pie charts. The underlying GD
routines do not fill the pie areas in a way that allows proper blending of
colors. Flat pie charts (using SetShading(0)) are not too bad, showing some
artifacts, but shaded or 3D-look pie charts are poorly rendered.

Bar charts and stacked bar charts - Bars are drawn properly, but the 3D
shading affects get blended, resulting in less than ideal appearance. Flat,
outlined bars (using SetShading(0)) are fine with transparency, but when
shading is on the 3D shadows overlap portions of the bars. With alpha
blending, the overlaps take on new colors.

-----------------------------------------------------------------------------
Background Image:

When creating a PHPlot or PHPlot_truecolor object, you can provide an
existing image filename to the constructor as the 4th argument, input_file.
     $plot = new PHPlot(800, 600, NULL, 'myimage.png');
This image file becomes the background for your plot. (The function
SetInputFile also does this, but is deprecated for use except through the
constructor.)

If you provide an input file to the constructor, the image associated with
your PHPlot or PHPlot_truecolor object takes on the type of the input file:
palette or truecolor. It does not matter which constructor you use when
specifying an input file. (This was changed after the initial release of
truecolor support in PHPlot-5.1.1.)

-----------------------------------------------------------------------------
Implementation:

The PHPlot_truecolor class extends the PHPlot class and replaces only the
constructor.  The PHPlot_truecolor constructor is a copy of the PHPlot
constructor (which it does not call), with the only change being use of
imagecreatetruecolor() instead of imagecreate().

All other changes to support truecolor images have been integrated into the
base class. That means you can specify alpha values for colors even with
palette images. However, this is not recommended. More details can be found
above.

+ SetIndexColor():
This internal function takes a general color specification and returns
a GD color index. It now uses imagecolorresolvealpha() instead of
imagecolorresolve(), and passes the alpha value from SetRGBColor() (see
below).

+ SetIndexDarkColor():
This internal function takes a general color specification and returns
a GD color index for a darker shade, is also changed to use
imagecolorresolvealpha(), similar to SetIndexColor.

+ SetRGBColor():
This internal function parses a color specification and converts it to a
canonical array component form. The color parsing was extended to support
alpha specifications in colors.  The function also now accepts an optional
alpha value to use as a default for colors that do not have an alpha value.
It now returns a 4 component array consisting of red, green, blue, and
alpha, rather than a 3 component array.

+ SetDataColors():
This public function now accepts a new parameter $default_alpha which it
applies to all data colors that don't already have an alpha specification.
It also saves the alpha value into a class variable $data_colors_alpha and
re-uses it as the default. This is necessary because PHPlot calls this
function again, with no arguments, to recalculate the color indexes.
Without saving and reusing the default alpha, all data colors would lose their
alpha value.

-----------------------------------------------------------------------------
Palette Images:

You will have a GD palette image if you use the PHPlot constructor without
a background image file, or if you use either the PHPlot or PHPlot_truecolor
constructors with a background image file that is a palette image (GIF or
some types of PNG). You can use alpha color specifications with palette GD
images, but this is not recommended. The results are not well documented,
but here are the current observations:

+ There is no alpha blending. Drawing operations simply replace existing
pixels values with the new pixel values. (These are actually index values
into the color table.)

+ Alpha values are ignored when the image is output to a JPEG or GIF file.
All colors are output as opaque.

+ Alpha values are preserved in PNG image files. These will be palette, not
truecolor, PNG images, with the color table containing the alpha values.
You can therefore have palette PNG files with partial transparency, however
not all viewers properly support this.

None of the advanced operations such as antialiasing or gamma adjust works
with palette images.

-----------------------------------------------------------------------------

History:

2010-04-03 First version, for PHPlot-5.1.1

2010-05-31 Update for CVS changes pending for next release after PHPlot-5.1.1.
  The truecolor functions have now been better integrated with the base class,
  leaving only the class constructor separate. The base class methods now also
  support specification of an alpha value, and they work to the extent that GD
  supports palette images with alpha values.

-----------------------------------------------------------------------------
